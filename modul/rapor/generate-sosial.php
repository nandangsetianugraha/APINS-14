<?php require_once '../../config/db.php';$kelas=$_REQUEST['kelas'];$tapel=$_REQUEST['tapel'];$smt=$_REQUEST['smt'];$idp=$_REQUEST['pdid'];$ab=substr($kelas, 0, 1);$validator = array('success' => false, 'messages' => array());/**$nm=$connect->query("select * from siswa where peserta_didik_id='$idp'")->fetch_assoc();$SB12=$connect->query("SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='1' and nilai='SB'")->num_rows;$PB12=$connect->query("SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='1' and nilai='PB'")->num_rows;$SB22=$connect->query("SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='2' and nilai='SB'")->num_rows;$PB22=$connect->query("SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='2' and nilai='PB'")->num_rows;$SB32=$connect->query("SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='3' and nilai='SB'")->num_rows;$PB32=$connect->query("SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='3' and nilai='PB'")->num_rows;$SB42=$connect->query("SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='4' and nilai='SB'")->num_rows;$PB42=$connect->query("SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='4' and nilai='PB'")->num_rows;$SB52=$connect->query("SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='5' and nilai='SB'")->num_rows;$PB52=$connect->query("SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='5' and nilai='PB'")->num_rows;$SB62=$connect->query("SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='6' and nilai='SB'")->num_rows;$PB62=$connect->query("SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='6' and nilai='PB'")->num_rows;**/$nm=mysqli_fetch_array(mysqli_query($koneksi, "select * from siswa where peserta_didik_id='$idp'"));$SB12=mysqli_num_rows(mysqli_query($koneksi, "SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='1' and nilai='SB'"));$PB12=mysqli_num_rows(mysqli_query($koneksi, "SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='1' and nilai='PB'"));$SB22=mysqli_num_rows(mysqli_query($koneksi, "SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='2' and nilai='SB'"));$PB22=mysqli_num_rows(mysqli_query($koneksi, "SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='2' and nilai='PB'"));$SB32=mysqli_num_rows(mysqli_query($koneksi, "SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='3' and nilai='SB'"));$PB32=mysqli_num_rows(mysqli_query($koneksi, "SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='3' and nilai='PB'"));$SB42=mysqli_num_rows(mysqli_query($koneksi, "SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='4' and nilai='SB'"));$PB42=mysqli_num_rows(mysqli_query($koneksi, "SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='4' and nilai='PB'"));$SB52=mysqli_num_rows(mysqli_query($koneksi, "SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='5' and nilai='SB'"));$PB52=mysqli_num_rows(mysqli_query($koneksi, "SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='5' and nilai='PB'"));$SB62=mysqli_num_rows(mysqli_query($koneksi, "SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='6' and nilai='SB'"));$PB62=mysqli_num_rows(mysqli_query($koneksi, "SELECT * FROM nso WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='6' and nilai='PB'"));
if($SB12==$PB12){	$pred1=2;}elseif($SB12<$PB12){	$pred1=1;}else{	$pred1=3;};
if($SB22==$PB22){	$pred2=2;}elseif($SB22<$PB22){	$pred2=1;}else{	$pred2=3;};
if($SB32==$PB32){	$pred3=2;}elseif($SB32<$PB32){	$pred3=1;}else{	$pred3=3;};
if($SB42==$PB42){	$pred4=2;}elseif($SB42<$PB42){	$pred4=1;}else{	$pred4=3;};
if($SB52==$PB52){	$pred5=2;}elseif($SB52<$PB52){	$pred5=1;}else{	$pred5=3;};
if($SB62==$PB62){	$pred6=2;}elseif($SB62<$PB62){	$pred6=1;}else{	$pred6=3;};
//input nilai spirit temp$nspi1=mysqli_num_rows(mysqli_query($koneksi, "select * from nso_temp WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='1'"));$nspi2=mysqli_num_rows(mysqli_query($koneksi, "select * from nso_temp WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='2'"));$nspi3=mysqli_num_rows(mysqli_query($koneksi, "select * from nso_temp WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='3'"));$nspi4=mysqli_num_rows(mysqli_query($koneksi, "select * from nso_temp WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='4'"));$nspi5=mysqli_num_rows(mysqli_query($koneksi, "select * from nso_temp WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='5'"));$nspi6=mysqli_num_rows(mysqli_query($koneksi, "select * from nso_temp WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='6'"));
if($nspi1>0){	$idnh=mysqli_fetch_array(mysqli_query($koneksi, "select * from nso_temp WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='1'"));	$idn=$idnh['id_nh'];	mysqli_query($koneksi, "update nso_temp set nph='$pred1' where id_nh='$idn'");}else{	mysqli_query($koneksi, "insert into nso_temp(id_pd,kelas,smt,tapel,jns,nph) values('$idp','$ab','$smt','$tapel','1','$pred1')");};
if($nspi2>0){	$idnh=mysqli_fetch_array(mysqli_query($koneksi, "select * from nso_temp WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='2'"));	$idn=$idnh['id_nh'];	mysqli_query($koneksi, "update nso_temp set nph='$pred2' where id_nh='$idn'");}else{	mysqli_query($koneksi, "insert into nso_temp(id_pd,kelas,smt,tapel,jns,nph) values('$idp','$ab','$smt','$tapel','2','$pred2')");};
if($nspi3>0){	$idnh=mysqli_fetch_array(mysqli_query($koneksi, "select * from nso_temp WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='3'"));	$idn=$idnh['id_nh'];	mysqli_query($koneksi, "update nso_temp set nph='$pred3' where id_nh='$idn'");}else{	mysqli_query($koneksi, "insert into nso_temp(id_pd,kelas,smt,tapel,jns,nph) values('$idp','$ab','$smt','$tapel','3','$pred3')");};
if($nspi4>0){	$idnh=mysqli_fetch_array(mysqli_query($koneksi, "select * from nso_temp WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='4'"));	$idn=$idnh['id_nh'];	mysqli_query($koneksi, "update nso_temp set nph='$pred4' where id_nh='$idn'");}else{	mysqli_query($koneksi, "insert into nso_temp(id_pd,kelas,smt,tapel,jns,nph) values('$idp','$ab','$smt','$tapel','4','$pred4')");};
if($nspi5>0){	$idnh=mysqli_fetch_array(mysqli_query($koneksi, "select * from nso_temp WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='5'"));	$idn=$idnh['id_nh'];	mysqli_query($koneksi, "update nso_temp set nph='$pred5' where id_nh='$idn'");}else{	mysqli_query($koneksi, "insert into nso_temp(id_pd,kelas,smt,tapel,jns,nph) values('$idp','$ab','$smt','$tapel','5','$pred5')");};
if($nspi6>0){	$idnh=mysqli_fetch_array(mysqli_query($koneksi, "select * from nso_temp WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and jns='6'"));	$idn=$idnh['id_nh'];	mysqli_query($koneksi, "update nso_temp set nph='$pred6' where id_nh='$idn'");}else{	mysqli_query($koneksi, "insert into nso_temp(id_pd,kelas,smt,tapel,jns,nph) values('$idp','$ab','$smt','$tapel','6','$pred6')");};
$vy1="";$dk1="";$dk="";$vy2="";$dk2="";$vy3="";$dk3="";$vy4="";$dk4="";$vy5="";$dk5="";$vy6="";$dk6="";$nu=array();
//Logika Berpikir disini.......$nsi=mysqli_query($koneksi, "select * from nso_temp WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel'");$ru=mysqli_num_rows($nsi);$nsi1=mysqli_query($koneksi, "select * from nso_temp WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and nph='3'");$ru1=mysqli_num_rows($nsi1);$nsi2=mysqli_query($koneksi, "select * from nso_temp WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and nph='2'");$ru2=mysqli_num_rows($nsi2);$nsi3=mysqli_query($koneksi, "select * from nso_temp WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and nph='1'");$ru3=mysqli_num_rows($nsi3);
if($ru1>0){	$ni1=mysqli_query($koneksi, "select * from nso_temp WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and nph='3'");	if($ru1==1){		$et=mysqli_fetch_array($ni1);		$tk=$et['jns'];		$fh=mysqli_fetch_array(mysqli_query($koneksi, "select * from kd_sosial where ids='$tk'"));		$vy1=$vy1.$fh['komp'];	}elseif($ru1==2){		$s=0;		while($et=mysqli_fetch_array($ni1)){			$s++;			$tk=$et['jns'];			$fh=mysqli_fetch_array(mysqli_query($koneksi, "select * from kd_sosial where ids='$tk'"));			$nu[$s]=$fh['komp'];		};		$vy1=$nu[1]." dan ".$nu[2];	}elseif($ru1==3){		$s=0;		while($et=mysqli_fetch_array($ni1)){			$s++;			$tk=$et['jns'];			$fh=mysqli_fetch_array(mysqli_query($koneksi, "select * from kd_sosial where ids='$tk'"));			$nu[$s]=$fh['komp'];		};		$vy1=$nu[1].", ".$nu[2]." dan ".$nu[3];	}elseif($ru1==4){		$s=0;		while($et=mysqli_fetch_array($ni1)){			$s++;			$tk=$et['jns'];			$fh=mysqli_fetch_array(mysqli_query($koneksi, "select * from kd_sosial where ids='$tk'"));			$nu[$s]=$fh['komp'];		};		$vy1=$nu[1].", ".$nu[2].", ".$nu[3]." dan ".$nu[4];	}elseif($ru1==5){		$s=0;		while($et=mysqli_fetch_array($ni1)){			$s++;			$tk=$et['jns'];			$fh=mysqli_fetch_array(mysqli_query($koneksi, "select * from kd_sosial where ids='$tk'"));			$nu[$s]=$fh['komp'];		};		$vy1=$nu[1].", ".$nu[2].", ".$nu[3].", ".$nu[4]." dan ".$nu[5];	}else{		$s=0;		while($et=mysqli_fetch_array($ni1)){			$s++;			$tk=$et['jns'];			$fh=mysqli_fetch_array(mysqli_query($koneksi, "select * from kd_sosial where ids='$tk'"));			$nu[$s]=$fh['komp'];		};		$vy1=$nu[1].", ".$nu[2].", ".$nu[3].", ".$nu[4].", ".$nu[5]." dan ".$nu[6];	};	$dk1="Sangat Baik dalam ".$vy1;};
if($ru2>0){	$ni2=mysqli_query($koneksi, "select * from nso_temp WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and nph='2'");	if($ru2==1){		$et=mysqli_fetch_array($ni2);		$tk=$et['jns'];		$fh=mysqli_fetch_array(mysqli_query($koneksi, "select * from kd_sosial where ids='$tk'"));		$vy2=$vy2.$fh['komp'];	}elseif($ru2==2){		$s=0;		while($et=mysqli_fetch_array($ni2)){			$s++;			$tk=$et['jns'];			$fh=mysqli_fetch_array(mysqli_query($koneksi, "select * from kd_sosial where ids='$tk'"));			$nu[$s]=$fh['komp'];		};		$vy2=$nu[1]." dan ".$nu[2];	}elseif($ru2==3){		$s=0;		while($et=mysqli_fetch_array($ni2)){			$s++;			$tk=$et['jns'];			$fh=mysqli_fetch_array(mysqli_query($koneksi, "select * from kd_sosial where ids='$tk'"));			$nu[$s]=$fh['komp'];		};		$vy2=$nu[1].", ".$nu[2]." dan ".$nu[3];	}elseif($ru2==4){		$p=0;		while($et=mysqli_fetch_array($ni2)){			$p++;			$tk=$et['jns'];			$fh=mysqli_fetch_array(mysqli_query($koneksi, "select * from kd_sosial where ids='$tk'"));			$nu[$p]=$fh['komp'];		};		$vy2=$nu[1].", ".$nu[2].", ".$nu[3]." dan ".$nu[4];	}elseif($ru2==5){		$p=0;		while($et=mysqli_fetch_array($ni2)){			$p++;			$tk=$et['jns'];			$fh=mysqli_fetch_array(mysqli_query($koneksi, "select * from kd_sosial where ids='$tk'"));			$nu[$p]=$fh['komp'];		};		$vy2=$nu[1].", ".$nu[2].", ".$nu[3].", ".$nu[4]." dan ".$nu[5];	}else{		$s=0;		while($et=mysqli_fetch_array($ni2)){			$s++;			$tk=$et['jns'];			$fh=mysqli_fetch_array(mysqli_query($koneksi, "select * from kd_sosial where ids='$tk'"));			$nu[$s]=$fh['komp'];		};		$vy2=$nu[1].", ".$nu[2].", ".$nu[3].", ".$nu[4].", ".$nu[5]." dan ".$nu[6];	};	$dk2="Baik dalam ".$vy2;};
if($ru3>0){	$ni3=mysqli_query($koneksi, "select * from nso_temp WHERE id_pd='$idp' and smt='$smt' and tapel='$tapel' and nph='1'");	if($ru3==1){		$et=mysqli_fetch_array($ni3);		$tk=$et['jns'];		$fh=mysqli_fetch_array(mysqli_query($koneksi, "select * from kd_sosial where ids='$tk'"));		$vy3=$vy3.$fh['komp'];	}elseif($ru3==2){		$s=0;		while($et=mysqli_fetch_array($ni3)){			$s++;			$tk=$et['jns'];			$fh=mysqli_fetch_array(mysqli_query($koneksi, "select * from kd_sosial where ids='$tk'"));			$nu[$s]=$fh['komp'];		};		$vy3=$nu[1]." dan ".$nu[2];	}elseif($ru3==3){		$s=0;		while($et=mysqli_fetch_array($ni3)){			$s++;			$tk=$et['jns'];			$fh=mysqli_fetch_array(mysqli_query($koneksi, "select * from kd_sosial where ids='$tk'"));			$nu[$s]=$fh['komp'];		};		$vy3=$nu[1].", ".$nu[2]." dan ".$nu[3];	}elseif($ru3==4){		$s=0;		while($et=mysqli_fetch_array($ni3)){			$s++;			$tk=$et['jns'];			$fh=mysqli_fetch_array(mysqli_query($koneksi, "select * from kd_sosial where ids='$tk'"));			$nu[$s]=$fh['komp'];		};		$vy3=$nu[1].", ".$nu[2].", ".$nu[3]." dan ".$nu[4];	}elseif($ru3==5){		$s=0;		while($et=mysqli_fetch_array($ni3)){			$s++;			$tk=$et['jns'];			$fh=mysqli_fetch_array(mysqli_query($koneksi, "select * from kd_sosial where ids='$tk'"));			$nu[$s]=$fh['komp'];		};		$vy3=$nu[1].", ".$nu[2].", ".$nu[3].", ".$nu[4]." dan ".$nu[5];	}else{		$s=0;		while($et=mysqli_fetch_array($ni3)){			$s++;			$tk=$et['jns'];			$fh=mysqli_fetch_array(mysqli_query($koneksi, "select * from kd_sosial where ids='$tk'"));			$nu[$s]=$fh['komp'];		};		$vy3=$nu[1].", ".$nu[2].", ".$nu[3].", ".$nu[4].", ".$nu[5]." dan ".$nu[6];	};	$dk3="Dengan Bimbingan serta Pendampingan yang lebih akan mampu meningkatkan ".$vy3;};
if($ru==0){	$dk="Alhamdulillah, Ananda ".$nm['nama']." Baik dalam Jujur, Disiplin, Tanggung Jawab, Santun, Peduli, dan Percaya Diri.";}else{	$dk="Alhamdulillah, Ananda ".$nm['nama']." ".$dk1." ".$dk2." ".$dk3;};
$desk=mysqli_real_escape_string($koneksi,$dk);$ada=mysqli_num_rows(mysqli_query($koneksi, "select * from deskripsi_k13 where id_pd='$idp' AND kelas='$ab' AND smt='$smt' AND tapel='$tapel' and jns='k2'"));$srapor=mysqli_fetch_array(mysqli_query($koneksi, "select * from deskripsi_k13 where id_pd='$idp' AND kelas='$ab' AND smt='$smt' AND tapel='$tapel' and jns='k2'"));
if($ada>0){	$idn=$srapor['id_raport'];	mysqli_query($koneksi, "UPDATE deskripsi_k13 SET deskripsi='$desk' WHERE id_raport='$idn'");}else{	mysqli_query($koneksi, "INSERT INTO deskripsi_k13(id_pd,kelas,smt,tapel,jns,deskripsi) VALUES('$idp','$ab','$smt','$tapel','k2','$desk')");};	mysqli_query($koneksi, "DELETE FROM nso_temp WHERE id_pd='$idp' and kelas='$ab' and smt='$smt' and tapel='$tapel'");
$validator['success'] = true;$validator['messages'] = "Rapor Sosial atas nama ".$nm['nama']." berhasil di Generate!";echo json_encode($validator);