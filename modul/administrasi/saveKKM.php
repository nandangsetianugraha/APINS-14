<?phprequire_once '../../config/db_connect.php';$validator = array('success' => false, 'KD' => array(), 'rata' => array(), 'kkmnya' => array());$kelas=substr($_REQUEST['kelas'],0,1);$tapel=$_REQUEST['tapel'];$mapel=$_REQUEST['mp'];$jns=$_REQUEST['column'];$kd=$_REQUEST['kda'];$nilai=$_REQUEST['value'];$jenis=$_REQUEST['jenis'];$cek = "select * from kkmku where kelas='$kelas' AND tapel='$tapel' AND mapel='$mapel' and kd='$kd' and jenis='$jenis'";$hasil = $connect->query($cek);$ada = $hasil->num_rows;if ($ada>0){	$cks=$hasil->fetch_assoc();	$idn=$cks['id_kkm'];	if($nilai==0 or empty($nilai)){		$sql="DELETE FROM kkmku WHERE id_kkm='$idn'";	}else{ 		$sql = "UPDATE kkmku SET nilai='$nilai' WHERE id_kkm='$idn'";	};}else{	$sql = "INSERT INTO kkmku(kelas,tapel,mapel,kd,jenis,nilai) VALUES('$kelas','$tapel','$mapel','$kd',$jenis,'$nilai')";};$tambahkkm = $connect->query($sql);$kkms=$connect->query("select AVG(nilai) as rerata from kkmku where kelas='$kelas' and tapel='$tapel' and mapel='$mapel' and kd='$kd'")->fetch_assoc();$sql2 = "select AVG(nilai) as ratarata from kkmku where kelas='$kelas' AND tapel='$tapel' AND mapel='$mapel'";$query2 = $connect->query($sql2);$cks2 = $query2->fetch_assoc();$kkmbeneran=$cks2['ratarata'];$sql12 = "select * from kkm where kelas='$kelas' AND tapel='$tapel' AND mapel='$mapel'";$query12 = $connect->query($sql12);$ada1 = $query12->num_rows;if($ada1>0){	$cks1 = $query12->fetch_assoc();	$idk=$cks1['id_kkm'];	$sqln = "UPDATE kkm SET nilai='$kkmbeneran' WHERE id_kkm='$idk'";	$hasilnya = $connect->query($sqln);	if($hasilnya === TRUE){		$idkd=explode('.',$kd);		$idkds=$idkd[0].$idkd[1];		$validator['success'] = true;		$validator['KD'] = $idkds;		$validator['rata'] = number_format($kkms['rerata'],0);		$validator['kkmnya'] = number_format($kkmbeneran,0);	}else{		$validator['success'] = false;	};}else{	$sql11 = "INSERT INTO kkm(kelas, tapel, mapel, nilai) VALUES('$kelas','$tapel','$mapel','$kkmbeneran')";	$hasilnya2 = $connect->query($sql11);	if($hasilnya2 === TRUE){		$idkd=explode('.',$kd);		$idkds=$idkd[0].$idkd[1];		$validator['success'] = true;		$validator['KD'] = $idkds;		$validator['rata'] = number_format($kkms['rerata'],0);		$validator['kkmnya'] = number_format($kkmbeneran,0);	}else{		$validator['success'] = false;	};}echo json_encode($validator);?>